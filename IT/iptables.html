<!doctype html>




<html class="theme-next mist">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/en/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/en/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/en/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Jason, Blog" />





  <link rel="alternate" href="/en/atom.xml" title="Jason" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/en/favicon.ico?v=5.0.1" />






<meta name="description" content="How iptables Worksiptables works by matching each packet that crosses the networking interface against a set of rules (grouped by chains) to decide what to do (called target).
rulesThe iptables firewa">
<meta property="og:type" content="article">
<meta property="og:title" content="iptables">
<meta property="og:url" content="http://atjason.com/en/IT/iptables.html">
<meta property="og:site_name" content="Jason">
<meta property="og:description" content="How iptables Worksiptables works by matching each packet that crosses the networking interface against a set of rules (grouped by chains) to decide what to do (called target).
rulesThe iptables firewa">
<meta property="og:updated_time" content="2016-08-06T08:56:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iptables">
<meta name="twitter:description" content="How iptables Worksiptables works by matching each packet that crosses the networking interface against a set of rules (grouped by chains) to decide what to do (called target).
rulesThe iptables firewa">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> iptables | Jason </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-26569268-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/en/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jason</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-categories">
          <a href="/en/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                iptables
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-07-16T11:49:56+08:00" content="2016-07-16">
              2016-07-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/en/categories/IT/" itemprop="url" rel="index">
                    <span itemprop="name">IT</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/en/IT/iptables.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="IT/iptables.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="How-iptables-Works"><a href="#How-iptables-Works" class="headerlink" title="How iptables Works"></a>How iptables Works</h1><p><code>iptables</code> works by matching each packet that crosses the networking interface against a set of <code>rules</code> (grouped by <code>chains</code>) to decide what to do (called <code>target</code>).</p>
<h2 id="rules"><a href="#rules" class="headerlink" title="rules"></a>rules</h2><p>The iptables firewall operates by comparing network traffic against a set of <code>rules</code>. The rules define the characteristics that a packet must have to match the rule, and the action that should be taken for matching packets.</p>
<h2 id="chains"><a href="#chains" class="headerlink" title="chains"></a>chains</h2><p>These rules are organized into groups called <code>chains</code>. A chain is a set of rules that a packet is checked against sequentially. When the packet matches one of the rules, it executes the associated action and is not checked against the remaining rules in the chain.<br>A user can create chains as needed. There are three chains defined by default. They are:<br>    ·    <strong>INPUT</strong>: This chain handles all packets that are addressed to your server.<br>    ·    <strong>OUTPUT</strong>: This chain contains rules for traffic created by your server.<br>    ·    <strong>FORWARD</strong>: This chain is used to deal with traffic destined for other servers that are not created on your server.<br><a id="more"></a></p>
<h3 id="policy"><a href="#policy" class="headerlink" title="policy"></a>policy</h3><p>Each chain can contain zero or more rules, and has a default <code>policy</code>. The policy determines what happens when a packet does not match any rule. So policy could also be treated as the last rule in chain.</p>
<h2 id="target"><a href="#target" class="headerlink" title="target"></a>target</h2><p>When the defined pattern matches, the action that takes place is called a <code>target</code>.</p>
<ul>
<li>A target can be a final policy decision for the packet, such as accept, or drop. </li>
<li>It can also be move the packet to a different chain for processing, or simply log the encounter.</li>
<li>There are many options.</li>
</ul>
<h2 id="IPv4-Versus-IPv6"><a href="#IPv4-Versus-IPv6" class="headerlink" title="IPv4 Versus IPv6"></a>IPv4 Versus IPv6</h2><p>The netfilter firewall that is included in the Linux kernel keeps IPv4 and IPv6 traffic completely separate. For IPv6 traffic, a companion command called <code>ip6tables</code> is used. </p>
<h2 id="Things-to-Keep-in-Mind"><a href="#Things-to-Keep-in-Mind" class="headerlink" title="Things to Keep in Mind"></a>Things to Keep in Mind</h2><ul>
<li>First, we need to make sure that we have rules to keep current connections active if we implement a default drop policy. This is especially important if you are connected to your server through SSH.</li>
<li>Another thing to keep in mind is that the order of the rules in each chain matter. <ul>
<li>Rules near the top of a chain should have a higher level of specificity than rules at the bottom.</li>
<li>You should match specific cases first, and then provide more general rules to match broader patterns.</li>
<li>If a packet falls through the entire chain (doesn’t match any rules), it will hit the most general rule, the default policy.</li>
<li>For this reason, a chain’s default policy very strongly dictates the types of rules that will be included in the chain. A chain with the default policy of ACCEPT will contain rules that explicitly drop packets. A chain that defaults to DROP will contain exceptions for packets that should be specifically accepted.</li>
</ul>
</li>
</ul>
<h1 id="List-Rules"><a href="#List-Rules" class="headerlink" title="List Rules"></a>List Rules</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -S</span><br></pre></td></tr></table></figure>
<p>Demo output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-P INPUT DROP</span><br><span class="line">-P FORWARD DROP</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-N ICMP</span><br><span class="line">-N TCP</span><br><span class="line">-N UDP</span><br><span class="line">-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line">-A INPUT -m conntrack --ctstate INVALID -j DROP</span><br><span class="line">-A INPUT -p udp -m conntrack --ctstate NEW -j UDP</span><br><span class="line">-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP</span><br><span class="line">-A INPUT -p icmp -m conntrack --ctstate NEW -j ICMP</span><br><span class="line">-A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable</span><br><span class="line">-A INPUT -p tcp -j REJECT --reject-with tcp-reset</span><br><span class="line">-A INPUT -j REJECT --reject-with icmp-proto-unreachable</span><br><span class="line">-A TCP -p tcp -m tcp --dport 22 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="List-Specific-Chain"><a href="#List-Specific-Chain" class="headerlink" title="List Specific Chain"></a>List Specific Chain</h2><p>Specify the chain name directly after the -S option. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -S INPUT</span><br></pre></td></tr></table></figure>
<p>Demo output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-P INPUT ACCEPT</span><br><span class="line">-A INPUT -s 39.187.179.166/32 -j DROP</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line">-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>##List Rules as Tables<br>Listing the iptables rules in the table view can be useful for comparing different rules against each other.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -L</span><br></pre></td></tr></table></figure>
<p>This will output all of current rules sorted by chain.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -L INPUT --line-numbers</span><br></pre></td></tr></table></figure>
<p>Demo output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt source               destination         </span><br><span class="line">1    f2b-shadowsocks  tcp  --  anywhere             anywhere             multiport dports 6000:6100</span><br><span class="line">2    f2b-mysqld-auth  tcp  --  anywhere             anywhere             multiport dports mysql</span><br><span class="line">3    f2b-php-url-fopen  tcp  --  anywhere             anywhere             multiport dports http,https</span><br><span class="line">4    f2b-nginx-botsearch  tcp  --  anywhere             anywhere             multiport dports http,https</span><br><span class="line">5    f2b-nginx-http-auth  tcp  --  anywhere             anywhere             multiport dports http,https</span><br><span class="line">6    f2b-sshd-ddos  tcp  --  anywhere             anywhere             multiport dports 7022</span><br><span class="line">7    f2b-sshd   tcp  --  anywhere             anywhere             multiport dports 7022</span><br><span class="line">8    DROP       all  --  39.187.179.166       anywhere            </span><br><span class="line">9    ACCEPT     all  --  anywhere             anywhere            </span><br><span class="line">10   ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED</span><br><span class="line">11   ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh</span><br><span class="line">12   ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http</span><br><span class="line">13   DROP       tcp  --  anywhere             anywhere             tcp dpt:mysql</span><br><span class="line">14   ACCEPT     icmp --  anywhere             anywhere             icmp echo-request</span><br></pre></td></tr></table></figure>
<p>The first line of output indicates the chain name (INPUT, in this case), followed by its default policy (DROP). The next line consists of the headers of each column in the table, and is followed by the chain’s rules.</p>
<ul>
<li><code>target</code>: If a packet matches the rule, the target specifies what should be done with it. For example, a packet can be accepted, dropped, logged, or sent to another chain to be compared against more rules</li>
<li><code>prot</code>: The protocol, such as tcp, udp, icmp, or all</li>
<li><code>opt</code>: Rarely used, this column indicates IP options</li>
<li><code>source</code>: The source IP address or subnet of the traffic, or anywhere</li>
<li><code>destination</code>: The destination IP address or subnet of the traffic, or anywhere</li>
</ul>
<p>The last column, which is not labeled, indicates the options of a rule.</p>
<h1 id="Add-Rules"><a href="#Add-Rules" class="headerlink" title="Add Rules"></a>Add Rules</h1><p>Accept connection on port 22 for ssh:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-A INPUT</code>: The -A flag <strong>appends</strong> a rule to the end of a chain (here the chain is INPUT). In another side <code>-I INPUT 2</code> means insert to the 2nd rule of INPUT chain.</li>
<li><code>-p tcp</code>: This option matches packets if the protocol being used is TCP.</li>
<li><code>--dport</code>: This option is available if the -p tcp flag is given. It gives a further requirement of matching the destination port for the matching packet.</li>
<li><code>-j ACCEPT</code>: This specifies the target of matching packets.</li>
</ul>
<h1 id="Delete-Rules"><a href="#Delete-Rules" class="headerlink" title="Delete Rules"></a>Delete Rules</h1><h2 id="Delete-Rule-by-Specification"><a href="#Delete-Rule-by-Specification" class="headerlink" title="Delete Rule by Specification"></a>Delete Rule by Specification</h2><p>For example, if you want to delete the rule that drops invalid incoming packets (-A INPUT -m conntrack –ctstate INVALID -j DROP), you could run this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -D INPUT -m conntrack --ctstate INVALID -j DROP</span><br></pre></td></tr></table></figure>
<p>Note that the -A option, which is used to indicate the rule position at creation time, should be excluded here.</p>
<h2 id="Delete-Rule-by-Chain-and-Number"><a href="#Delete-Rule-by-Chain-and-Number" class="headerlink" title="Delete Rule by Chain and Number"></a>Delete Rule by Chain and Number</h2><p>To determine a rule’s line number, list the rules in the table format and add the –line-numbers option:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -L --line-numbers</span><br></pre></td></tr></table></figure>
<p>Then run theiptables -D command followed by the chain and rule number.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -D INPUT 3</span><br></pre></td></tr></table></figure>
<h1 id="Drop-Rules"><a href="#Drop-Rules" class="headerlink" title="Drop Rules"></a>Drop Rules</h1><p>There’re 2 ways for drop:</p>
<ul>
<li>Set the default policy for chain as <code>ACCEPT</code>. Then if a connection doesn’t march any rules in the chain, it will be accepted. <ul>
<li>If using this way, need to set drop rule one by one. If missed on, it will be security hole.</li>
</ul>
</li>
<li>Set the default policy for chain as <code>DROP</code>. Then if a connection doesn’t march any rules in the chain, it will be dropped.<ul>
<li>If using this way, only need to set accept rules. All others will be dropped by default. It’s strict but safe.</li>
</ul>
</li>
</ul>
<p>Set policy of chain to <code>ACCEPT</code> or <code>DROP</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P INPUT DROP</span><br></pre></td></tr></table></figure>
<p>Add a <code>DROP</code> rule in <code>INPUT</code> chain:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -j DROP</span><br></pre></td></tr></table></figure>
<h1 id="Block-an-IP-Address"><a href="#Block-an-IP-Address" class="headerlink" title="Block an IP Address"></a>Block an IP Address</h1><p>To block network connections that originate from a specific IP address, 15.15.15.51 for example, run this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -s 15.15.15.51 -j DROP</span><br></pre></td></tr></table></figure>
<p>If you want to reject the connection instead, which will respond to the connection request with a “connection refused” error, replace “DROP” with “REJECT” like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -s 15.15.15.51 -j REJECT</span><br></pre></td></tr></table></figure>
<h1 id="Show-Packet-Counts-and-Aggregate-Size"><a href="#Show-Packet-Counts-and-Aggregate-Size" class="headerlink" title="Show Packet Counts and Aggregate Size"></a>Show Packet Counts and Aggregate Size</h1><p>This is often useful when trying to get a rough idea of which rules are matching against packets. For example, let’s look at the INPUT chain again, with the -v option:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -L INPUT -v</span><br></pre></td></tr></table></figure>
<p>Example: Verbose Listing</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> 284K   42M ACCEPT     all  --  any    any     anywhere             anywhere             ctstate RELATED,ESTABLISHED</span><br><span class="line">    0     0 ACCEPT     all  --  lo     any     anywhere             anywhere</span><br><span class="line">    0     0 DROP       all  --  any    any     anywhere             anywhere             ctstate INVALID</span><br><span class="line">  396 63275 UDP        udp  --  any    any     anywhere             anywhere             ctstate NEW</span><br><span class="line">17067 1005K TCP        tcp  --  any    any     anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN ctstate NEW</span><br><span class="line"> 2410  154K ICMP       icmp --  any    any     anywhere             anywhere             ctstate NEW</span><br><span class="line">  396 63275 REJECT     udp  --  any    any     anywhere             anywhere             reject-with icmp-port-unreachable</span><br><span class="line"> 2916  179K REJECT     all  --  any    any     anywhere             anywhere             reject-with icmp-proto-unreachable</span><br><span class="line">    0     0 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh ctstate NEW,ESTABLISHED</span><br></pre></td></tr></table></figure>
<h2 id="Reset-Packet-Counts-and-Aggregate-Size"><a href="#Reset-Packet-Counts-and-Aggregate-Size" class="headerlink" title="Reset Packet Counts and Aggregate Size"></a>Reset Packet Counts and Aggregate Size</h2><p>They also reset if a reboot occurs. This is useful if you want to see if your server is receiving new traffic that matches your existing rules.</p>
<p>To clear the counters for all chains and rules, use the -Z option by itself:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -Z</span><br><span class="line">sudo iptables -Z INPUT</span><br><span class="line">sudo iptables -Z INPUT 1</span><br></pre></td></tr></table></figure>
<h1 id="Save-iptables-Configuration"><a href="#Save-iptables-Configuration" class="headerlink" title="Save iptables Configuration"></a>Save iptables Configuration</h1><p>By default, the rules that you add to iptables are ephemeral. This means that when you restart your server, your iptables rules will be gone. The easiest way to save is with the iptables-persistent package.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install iptables-persistent</span><br></pre></td></tr></table></figure>
<p>Once the installation is complete, you will have a new service called <code>iptables-persistent</code> that is configured to run at boot. This service will load in your rules and apply them when the server is started.</p>
<p>If you ever update your firewall and want to preserve the changes, you must save your iptables rules for them to be persistent.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service netfilter-persistent save</span><br></pre></td></tr></table></figure>
<p>This will overwrite your /etc/iptables/rules.v4 and /etc/iptables/rules.v6 files with the policies you crafted on the command line.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/iptables.rules </span><br><span class="line">/etc/iptables/rules.v4</span><br><span class="line">/etc/iptables/rules.v6</span><br></pre></td></tr></table></figure>
<h1 id="Create-Your-Own-Firewall-by-iptables"><a href="#Create-Your-Own-Firewall-by-iptables" class="headerlink" title="Create Your Own Firewall by iptables"></a>Create Your Own Firewall by iptables</h1><p>Pre-condititions:</p>
<ul>
<li>Backup existing iptables. Could just copy output of <code>sudo iptables -S</code>, or copy rules saved by <code>iptables-persistent</code> as mentioned above.</li>
<li>If you lock yourself from accessing using ssh, make sure you have other ways to access it.</li>
</ul>
<h2 id="Create-Protocol-Specific-Chains"><a href="#Create-Protocol-Specific-Chains" class="headerlink" title="Create Protocol-Specific Chains"></a>Create Protocol-Specific Chains</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -N UDP</span><br><span class="line">sudo iptables -N TCP</span><br><span class="line">sudo iptables -N ICMP</span><br></pre></td></tr></table></figure>
<p>Enable ssh, http, https:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A TCP -p tcp --dport 22 -j ACCEPT</span><br><span class="line">sudo iptables -A TCP -p tcp --dport 80,443 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>Enable other custom service:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A TCP -p tcp --dport 8000:8010 -j ACCEPT</span><br><span class="line">sudo iptables -A UDP -p udp --dport 8000:8010 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="Create-General-Purpose-Accept-and-Deny-Rules"><a href="#Create-General-Purpose-Accept-and-Deny-Rules" class="headerlink" title="Create General Purpose Accept and Deny Rules"></a>Create General Purpose Accept and Deny Rules</h2><p>First, we will create an exception to accept all traffic that is part of an established connection or is related to an established connection:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>Allow all traffic originating on the local loopback interface.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>Finally, we want to deny all invalid packets.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -m conntrack --ctstate INVALID -j DROP</span><br></pre></td></tr></table></figure>
<h2 id="Creating-the-Jump-Rules-to-the-Protocol-Specific-Chains"><a href="#Creating-the-Jump-Rules-to-the-Protocol-Specific-Chains" class="headerlink" title="Creating the Jump Rules to the Protocol-Specific Chains"></a>Creating the Jump Rules to the Protocol-Specific Chains</h2><p>Direct traffic in the INPUT chain into the appropriate protocol-specific chains. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p udp -m conntrack --ctstate NEW -j UDP</span><br><span class="line">sudo iptables -A INPUT -p tcp --syn -m conntrack --ctstate NEW -j TCP</span><br><span class="line">sudo iptables -A INPUT -p icmp -m conntrack --ctstate NEW -j ICMP</span><br></pre></td></tr></table></figure>
<h2 id="Reject-All-Remaining-Traffic"><a href="#Reject-All-Remaining-Traffic" class="headerlink" title="Reject All Remaining Traffic"></a>Reject All Remaining Traffic</h2><p>If a packet that was passed to a protocol-specific chain did not match any of the rules within, control will be passed back to the INPUT chain. Anything that reaches this point should not be allowed by our firewall. We will deny the traffic using the REJECT target, which sends a response message to the client. </p>
<p>Attempting to reach a closed UDP port will result in an ICMP “port unreachable” message.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable</span><br></pre></td></tr></table></figure>
<p>Attempting to establish a TCP connection on a closed port results in a TCP RST response:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset</span><br></pre></td></tr></table></figure>
<p>For all other packets, we can send an ICMP “protocol unreachable” message to indicate that the server doesn’t respond to packets of that type:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -j REJECT --reject-with icmp-proto-unreachable</span><br></pre></td></tr></table></figure>
<h2 id="Adjusting-Default-Policies"><a href="#Adjusting-Default-Policies" class="headerlink" title="Adjusting Default Policies"></a>Adjusting Default Policies</h2><p>Set the default policy to DROP as a precaution.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -P INPUT DROP</span><br><span class="line">sudo iptables -P FORWARD DROP</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="Saving-iptables-Rules"><a href="#Saving-iptables-Rules" class="headerlink" title="Saving iptables Rules"></a>Saving iptables Rules</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service netfilter-persistent save</span><br><span class="line">or </span><br><span class="line">sudo /etc/init.d/iptables-persistent save</span><br></pre></td></tr></table></figure>
<p>This will overwrite your /etc/iptables/rules.v4 and /etc/iptables/rules.v6 files with the policies you crafted on the command line.</p>
<h1 id="Test-your-Firewall-Configuration-with-Nmap-and-Tcpdump"><a href="#Test-your-Firewall-Configuration-with-Nmap-and-Tcpdump" class="headerlink" title="Test your Firewall Configuration with Nmap and Tcpdump"></a>Test your Firewall Configuration with Nmap and Tcpdump</h1><p><a href="https://www.digitalocean.com/community/tutorials/how-to-test-your-firewall-configuration-with-nmap-and-tcpdump" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-test-your-firewall-configuration-with-nmap-and-tcpdump</a></p>
<p>Preconditions:</p>
<ul>
<li>Install tcpdump build-essential libssl-dev, nmap</li>
</ul>
<h2 id="Scan-your-Target-for-Open-TCP-Ports"><a href="#Scan-your-Target-for-Open-TCP-Ports" class="headerlink" title="Scan your Target for Open TCP Ports"></a>Scan your Target for Open TCP Ports</h2><p>Setting Up the Packet Capture</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump host target_ip_addr -w ~/scan_results/syn_scan/packets</span><br></pre></td></tr></table></figure>
<p>With <code>tcpdump</code> recording our traffic to the target machine, we are ready to run the SYN scan using <code>nmap</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sS -Pn -p- -T4 -vv --reason -oN ~/scan_results/syn_scan/nmap.results target_ip_addr</span><br></pre></td></tr></table></figure>
<p>The results are saved in ~/scan_results/syn_scan/nmap.results.</p>
<h2 id="Scan-your-Target-for-Open-UDP-Ports"><a href="#Scan-your-Target-for-Open-UDP-Ports" class="headerlink" title="Scan your Target for Open UDP Ports"></a>Scan your Target for Open UDP Ports</h2><p>Setting Up the Packet Capture</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump host target_ip_addr -w ~/scan_results/udp_scan/packets</span><br></pre></td></tr></table></figure>
<p>Run the UDP Scan</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sU -Pn -p- -T4 -vv --reason -oN ~/scan_results/udp_scan/nmap.results target_ip_addr</span><br></pre></td></tr></table></figure>
<p>The results are saved in ~/scan_results/syn_scan/nmap.results.</p>
<h2 id="Host-and-Service-Discovery"><a href="#Host-and-Service-Discovery" class="headerlink" title="Host and Service Discovery"></a>Host and Service Discovery</h2><p>Discovering the Versions of Services on the Server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sV -Pn -p 22,80 -vv --reason -oN ~/scan_results/versions/service_versions.nmap target_ip_addr</span><br></pre></td></tr></table></figure>
<p>Discovering the Host Operating System</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -O -Pn -vv --reason -oN ~/scan_results/versions/os_version.nmap target_ip_addr</span><br></pre></td></tr></table></figure>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-the-iptables-firewall-works" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-the-iptables-firewall-works</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-using-iptables-on-ubuntu-14-04" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-using-iptables-on-ubuntu-14-04</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules</a></li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/en/Cocoa/MacGoogleAnalytics.html" rel="next" title="Google Analytics for Mac">
                <i class="fa fa-chevron-left"></i> Google Analytics for Mac
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ww3.sinaimg.cn/large/006ghf8igw1f3lxt6lgnsj30lc0jygn8.jpg"
               alt="Jason" />
          <p class="site-author-name" itemprop="name">Jason</p>
          <p class="site-description motion-element" itemprop="description">Digital Nomad, Mac Developer</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/en/">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/en/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/en/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/atjason" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/hereisjason" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/atjasonzone" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://toolinbox.net/" title="Toolinbox" target="_blank">Toolinbox</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#How-iptables-Works"><span class="nav-number">1.</span> <span class="nav-text">How iptables Works</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#rules"><span class="nav-number">1.1.</span> <span class="nav-text">rules</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chains"><span class="nav-number">1.2.</span> <span class="nav-text">chains</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#policy"><span class="nav-number">1.2.1.</span> <span class="nav-text">policy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#target"><span class="nav-number">1.3.</span> <span class="nav-text">target</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPv4-Versus-IPv6"><span class="nav-number">1.4.</span> <span class="nav-text">IPv4 Versus IPv6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Things-to-Keep-in-Mind"><span class="nav-number">1.5.</span> <span class="nav-text">Things to Keep in Mind</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#List-Rules"><span class="nav-number">2.</span> <span class="nav-text">List Rules</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#List-Specific-Chain"><span class="nav-number">2.1.</span> <span class="nav-text">List Specific Chain</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Add-Rules"><span class="nav-number">3.</span> <span class="nav-text">Add Rules</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Delete-Rules"><span class="nav-number">4.</span> <span class="nav-text">Delete Rules</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Delete-Rule-by-Specification"><span class="nav-number">4.1.</span> <span class="nav-text">Delete Rule by Specification</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Delete-Rule-by-Chain-and-Number"><span class="nav-number">4.2.</span> <span class="nav-text">Delete Rule by Chain and Number</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Drop-Rules"><span class="nav-number">5.</span> <span class="nav-text">Drop Rules</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Block-an-IP-Address"><span class="nav-number">6.</span> <span class="nav-text">Block an IP Address</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Show-Packet-Counts-and-Aggregate-Size"><span class="nav-number">7.</span> <span class="nav-text">Show Packet Counts and Aggregate Size</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reset-Packet-Counts-and-Aggregate-Size"><span class="nav-number">7.1.</span> <span class="nav-text">Reset Packet Counts and Aggregate Size</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Save-iptables-Configuration"><span class="nav-number">8.</span> <span class="nav-text">Save iptables Configuration</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create-Your-Own-Firewall-by-iptables"><span class="nav-number">9.</span> <span class="nav-text">Create Your Own Firewall by iptables</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Protocol-Specific-Chains"><span class="nav-number">9.1.</span> <span class="nav-text">Create Protocol-Specific Chains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-General-Purpose-Accept-and-Deny-Rules"><span class="nav-number">9.2.</span> <span class="nav-text">Create General Purpose Accept and Deny Rules</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-the-Jump-Rules-to-the-Protocol-Specific-Chains"><span class="nav-number">9.3.</span> <span class="nav-text">Creating the Jump Rules to the Protocol-Specific Chains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reject-All-Remaining-Traffic"><span class="nav-number">9.4.</span> <span class="nav-text">Reject All Remaining Traffic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Adjusting-Default-Policies"><span class="nav-number">9.5.</span> <span class="nav-text">Adjusting Default Policies</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Saving-iptables-Rules"><span class="nav-number">9.6.</span> <span class="nav-text">Saving iptables Rules</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Test-your-Firewall-Configuration-with-Nmap-and-Tcpdump"><span class="nav-number">10.</span> <span class="nav-text">Test your Firewall Configuration with Nmap and Tcpdump</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Scan-your-Target-for-Open-TCP-Ports"><span class="nav-number">10.1.</span> <span class="nav-text">Scan your Target for Open TCP Ports</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scan-your-Target-for-Open-UDP-Ports"><span class="nav-number">10.2.</span> <span class="nav-text">Scan your Target for Open UDP Ports</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Host-and-Service-Discovery"><span class="nav-number">10.3.</span> <span class="nav-text">Host and Service Discovery</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">11.</span> <span class="nav-text">References</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jason</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/en/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/en/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/en/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/en/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/en/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/en/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/en/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/en/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/en/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/en/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/en/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'atjason';
      var disqus_identifier = 'IT/iptables.html';
      var disqus_title = 'iptables';
      var disqus_url = 'http://atjason.com/en/en/IT/iptables.html';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/en/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
