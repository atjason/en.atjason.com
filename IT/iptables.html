<!doctype html><html class="theme-next mist" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css"><meta name="keywords" content="Jason,Blog"><link rel="alternate" href="/atom.xml" title="Jason" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1"><meta name="description" content="How iptables Worksiptables works by matching each packet that crosses the networking interface against a set of rules (grouped by chains) to decide what to do (called target).rulesThe iptables firewal"><meta name="keywords"><meta property="og:type" content="article"><meta property="og:title" content="iptables"><meta property="og:url" content="https://en.atjason.com/IT/iptables.html"><meta property="og:site_name" content="Jason"><meta property="og:description" content="How iptables Worksiptables works by matching each packet that crosses the networking interface against a set of rules (grouped by chains) to decide what to do (called target).rulesThe iptables firewal"><meta property="og:updated_time" content="2016-12-06T01:51:54.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="iptables"><meta name="twitter:description" content="How iptables Worksiptables works by matching each packet that crosses the networking interface against a set of rules (grouped by chains) to decide what to do (called target).rulesThe iptables firewal"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"left",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!1,motion:!1,duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://en.atjason.com/IT/iptables.html"><title>iptables | Jason</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src="https://www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-26569268-1","auto"),ga("send","pageview")</script><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Jason</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://en.atjason.com/IT/iptables.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Jason"><meta itemprop="description" content=""><meta itemprop="image" content="https://i.imgur.com/lS5NEuU.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jason"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">iptables</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-16T11:49:56+08:00">2016-07-16 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/IT/" itemprop="url" rel="index"><span itemprop="name">IT</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="How-iptables-Works"><a href="#How-iptables-Works" class="headerlink" title="How iptables Works"></a>How iptables Works</h1><p><code>iptables</code> works by matching each packet that crosses the networking interface against a set of <code>rules</code> (grouped by <code>chains</code>) to decide what to do (called <code>target</code>).</p><h2 id="rules"><a href="#rules" class="headerlink" title="rules"></a>rules</h2><p>The iptables firewall operates by comparing network traffic against a set of <code>rules</code>. The rules define the characteristics that a packet must have to match the rule, and the action that should be taken for matching packets.</p><h2 id="chains"><a href="#chains" class="headerlink" title="chains"></a>chains</h2><p>These rules are organized into groups called <code>chains</code>. A chain is a set of rules that a packet is checked against sequentially. When the packet matches one of the rules, it executes the associated action and is not checked against the remaining rules in the chain.<br>A user can create chains as needed. There are three chains defined by default. They are:<br>· <strong>INPUT</strong>: This chain handles all packets that are addressed to your server.<br>· <strong>OUTPUT</strong>: This chain contains rules for traffic created by your server.<br>· <strong>FORWARD</strong>: This chain is used to deal with traffic destined for other servers that are not created on your server.<br><a id="more"></a></p><h3 id="policy"><a href="#policy" class="headerlink" title="policy"></a>policy</h3><p>Each chain can contain zero or more rules, and has a default <code>policy</code>. The policy determines what happens when a packet does not match any rule. So policy could also be treated as the last rule in chain.</p><h2 id="target"><a href="#target" class="headerlink" title="target"></a>target</h2><p>When the defined pattern matches, the action that takes place is called a <code>target</code>.</p><ul><li>A target can be a final policy decision for the packet, such as accept, or drop.</li><li>It can also be move the packet to a different chain for processing, or simply log the encounter.</li><li>There are many options.</li></ul><h2 id="IPv4-Versus-IPv6"><a href="#IPv4-Versus-IPv6" class="headerlink" title="IPv4 Versus IPv6"></a>IPv4 Versus IPv6</h2><p>The netfilter firewall that is included in the Linux kernel keeps IPv4 and IPv6 traffic completely separate. For IPv6 traffic, a companion command called <code>ip6tables</code> is used.</p><h2 id="Things-to-Keep-in-Mind"><a href="#Things-to-Keep-in-Mind" class="headerlink" title="Things to Keep in Mind"></a>Things to Keep in Mind</h2><ul><li>First, we need to make sure that we have rules to keep current connections active if we implement a default drop policy. This is especially important if you are connected to your server through SSH.</li><li>Another thing to keep in mind is that the order of the rules in each chain matter.<ul><li>Rules near the top of a chain should have a higher level of specificity than rules at the bottom.</li><li>You should match specific cases first, and then provide more general rules to match broader patterns.</li><li>If a packet falls through the entire chain (doesn’t match any rules), it will hit the most general rule, the default policy.</li><li>For this reason, a chain’s default policy very strongly dictates the types of rules that will be included in the chain. A chain with the default policy of ACCEPT will contain rules that explicitly drop packets. A chain that defaults to DROP will contain exceptions for packets that should be specifically accepted.</li></ul></li></ul><h1 id="List-Rules"><a href="#List-Rules" class="headerlink" title="List Rules"></a>List Rules</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -S</div></pre></td></tr></table></figure><p>Demo output:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">-P INPUT DROP</div><div class="line">-P FORWARD DROP</div><div class="line">-P OUTPUT ACCEPT</div><div class="line">-N ICMP</div><div class="line">-N TCP</div><div class="line">-N UDP</div><div class="line">-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</div><div class="line">-A INPUT -i lo -j ACCEPT</div><div class="line">-A INPUT -m conntrack --ctstate INVALID -j DROP</div><div class="line">-A INPUT -p udp -m conntrack --ctstate NEW -j UDP</div><div class="line">-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP</div><div class="line">-A INPUT -p icmp -m conntrack --ctstate NEW -j ICMP</div><div class="line">-A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable</div><div class="line">-A INPUT -p tcp -j REJECT --reject-with tcp-reset</div><div class="line">-A INPUT -j REJECT --reject-with icmp-proto-unreachable</div><div class="line">-A TCP -p tcp -m tcp --dport 22 -j ACCEPT</div></pre></td></tr></table></figure><h2 id="List-Specific-Chain"><a href="#List-Specific-Chain" class="headerlink" title="List Specific Chain"></a>List Specific Chain</h2><p>Specify the chain name directly after the -S option.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -S INPUT</div></pre></td></tr></table></figure><p>Demo output:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-P INPUT ACCEPT</div><div class="line">-A INPUT -s 39.187.179.166/32 -j DROP</div><div class="line">-A INPUT -i lo -j ACCEPT</div><div class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</div><div class="line">-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT</div><div class="line">-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT</div><div class="line">-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT</div></pre></td></tr></table></figure><p>##List Rules as Tables<br>Listing the iptables rules in the table view can be useful for comparing different rules against each other.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -L</div></pre></td></tr></table></figure><p>This will output all of current rules sorted by chain.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -L INPUT --line-numbers</div></pre></td></tr></table></figure><p>Demo output:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">num  target     prot opt source               destination         </div><div class="line">1    f2b-shadowsocks  tcp  --  anywhere             anywhere             multiport dports 6000:6100</div><div class="line">2    f2b-mysqld-auth  tcp  --  anywhere             anywhere             multiport dports mysql</div><div class="line">3    f2b-php-url-fopen  tcp  --  anywhere             anywhere             multiport dports http,https</div><div class="line">4    f2b-nginx-botsearch  tcp  --  anywhere             anywhere             multiport dports http,https</div><div class="line">5    f2b-nginx-http-auth  tcp  --  anywhere             anywhere             multiport dports http,https</div><div class="line">6    f2b-sshd-ddos  tcp  --  anywhere             anywhere             multiport dports 7022</div><div class="line">7    f2b-sshd   tcp  --  anywhere             anywhere             multiport dports 7022</div><div class="line">8    DROP       all  --  39.187.179.166       anywhere            </div><div class="line">9    ACCEPT     all  --  anywhere             anywhere            </div><div class="line">10   ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED</div><div class="line">11   ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh</div><div class="line">12   ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http</div><div class="line">13   DROP       tcp  --  anywhere             anywhere             tcp dpt:mysql</div><div class="line">14   ACCEPT     icmp --  anywhere             anywhere             icmp echo-request</div></pre></td></tr></table></figure><p>The first line of output indicates the chain name (INPUT, in this case), followed by its default policy (DROP). The next line consists of the headers of each column in the table, and is followed by the chain’s rules.</p><ul><li><code>target</code>: If a packet matches the rule, the target specifies what should be done with it. For example, a packet can be accepted, dropped, logged, or sent to another chain to be compared against more rules</li><li><code>prot</code>: The protocol, such as tcp, udp, icmp, or all</li><li><code>opt</code>: Rarely used, this column indicates IP options</li><li><code>source</code>: The source IP address or subnet of the traffic, or anywhere</li><li><code>destination</code>: The destination IP address or subnet of the traffic, or anywhere</li></ul><p>The last column, which is not labeled, indicates the options of a rule.</p><h1 id="Add-Rules"><a href="#Add-Rules" class="headerlink" title="Add Rules"></a>Add Rules</h1><p>Accept connection on port 22 for ssh:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT</div></pre></td></tr></table></figure><ul><li><code>-A INPUT</code>: The -A flag <strong>appends</strong> a rule to the end of a chain (here the chain is INPUT). In another side <code>-I INPUT 2</code> means insert to the 2nd rule of INPUT chain.</li><li><code>-p tcp</code>: This option matches packets if the protocol being used is TCP.</li><li><code>--dport</code>: This option is available if the -p tcp flag is given. It gives a further requirement of matching the destination port for the matching packet.</li><li><code>-j ACCEPT</code>: This specifies the target of matching packets.</li></ul><h1 id="Delete-Rules"><a href="#Delete-Rules" class="headerlink" title="Delete Rules"></a>Delete Rules</h1><h2 id="Delete-Rule-by-Specification"><a href="#Delete-Rule-by-Specification" class="headerlink" title="Delete Rule by Specification"></a>Delete Rule by Specification</h2><p>For example, if you want to delete the rule that drops invalid incoming packets (-A INPUT -m conntrack –ctstate INVALID -j DROP), you could run this command:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -D INPUT -m conntrack --ctstate INVALID -j DROP</div></pre></td></tr></table></figure><p>Note that the -A option, which is used to indicate the rule position at creation time, should be excluded here.</p><h2 id="Delete-Rule-by-Chain-and-Number"><a href="#Delete-Rule-by-Chain-and-Number" class="headerlink" title="Delete Rule by Chain and Number"></a>Delete Rule by Chain and Number</h2><p>To determine a rule’s line number, list the rules in the table format and add the –line-numbers option:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -L --line-numbers</div></pre></td></tr></table></figure><p>Then run theiptables -D command followed by the chain and rule number.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -D INPUT 3</div></pre></td></tr></table></figure><h1 id="Drop-Rules"><a href="#Drop-Rules" class="headerlink" title="Drop Rules"></a>Drop Rules</h1><p>There’re 2 ways for drop:</p><ul><li>Set the default policy for chain as <code>ACCEPT</code>. Then if a connection doesn’t march any rules in the chain, it will be accepted.<ul><li>If using this way, need to set drop rule one by one. If missed on, it will be security hole.</li></ul></li><li>Set the default policy for chain as <code>DROP</code>. Then if a connection doesn’t march any rules in the chain, it will be dropped.<ul><li>If using this way, only need to set accept rules. All others will be dropped by default. It’s strict but safe.</li></ul></li></ul><p>Set policy of chain to <code>ACCEPT</code> or <code>DROP</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo iptables -P INPUT ACCEPT</div><div class="line">sudo iptables -P INPUT DROP</div></pre></td></tr></table></figure><p>Add a <code>DROP</code> rule in <code>INPUT</code> chain:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -j DROP</div></pre></td></tr></table></figure><h1 id="Block-an-IP-Address"><a href="#Block-an-IP-Address" class="headerlink" title="Block an IP Address"></a>Block an IP Address</h1><p>To block network connections that originate from a specific IP address, 15.15.15.51 for example, run this command:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -s 15.15.15.51 -j DROP</div></pre></td></tr></table></figure><p>If you want to reject the connection instead, which will respond to the connection request with a “connection refused” error, replace “DROP” with “REJECT” like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -s 15.15.15.51 -j REJECT</div></pre></td></tr></table></figure><h1 id="Show-Packet-Counts-and-Aggregate-Size"><a href="#Show-Packet-Counts-and-Aggregate-Size" class="headerlink" title="Show Packet Counts and Aggregate Size"></a>Show Packet Counts and Aggregate Size</h1><p>This is often useful when trying to get a rough idea of which rules are matching against packets. For example, let’s look at the INPUT chain again, with the -v option:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -L INPUT -v</div></pre></td></tr></table></figure><p>Example: Verbose Listing</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination</div><div class="line"> 284K   42M ACCEPT     all  --  any    any     anywhere             anywhere             ctstate RELATED,ESTABLISHED</div><div class="line">    0     0 ACCEPT     all  --  lo     any     anywhere             anywhere</div><div class="line">    0     0 DROP       all  --  any    any     anywhere             anywhere             ctstate INVALID</div><div class="line">  396 63275 UDP        udp  --  any    any     anywhere             anywhere             ctstate NEW</div><div class="line">17067 1005K TCP        tcp  --  any    any     anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN ctstate NEW</div><div class="line"> 2410  154K ICMP       icmp --  any    any     anywhere             anywhere             ctstate NEW</div><div class="line">  396 63275 REJECT     udp  --  any    any     anywhere             anywhere             reject-with icmp-port-unreachable</div><div class="line"> 2916  179K REJECT     all  --  any    any     anywhere             anywhere             reject-with icmp-proto-unreachable</div><div class="line">    0     0 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh ctstate NEW,ESTABLISHED</div></pre></td></tr></table></figure><h2 id="Reset-Packet-Counts-and-Aggregate-Size"><a href="#Reset-Packet-Counts-and-Aggregate-Size" class="headerlink" title="Reset Packet Counts and Aggregate Size"></a>Reset Packet Counts and Aggregate Size</h2><p>They also reset if a reboot occurs. This is useful if you want to see if your server is receiving new traffic that matches your existing rules.</p><p>To clear the counters for all chains and rules, use the -Z option by itself:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo iptables -Z</div><div class="line">sudo iptables -Z INPUT</div><div class="line">sudo iptables -Z INPUT 1</div></pre></td></tr></table></figure><h1 id="Save-iptables-Configuration"><a href="#Save-iptables-Configuration" class="headerlink" title="Save iptables Configuration"></a>Save iptables Configuration</h1><p>By default, the rules that you add to iptables are ephemeral. This means that when you restart your server, your iptables rules will be gone. The easiest way to save is with the iptables-persistent package.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install iptables-persistent</div></pre></td></tr></table></figure><p>Once the installation is complete, you will have a new service called <code>iptables-persistent</code> that is configured to run at boot. This service will load in your rules and apply them when the server is started.</p><p>If you ever update your firewall and want to preserve the changes, you must save your iptables rules for them to be persistent.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service netfilter-persistent save</div></pre></td></tr></table></figure><p>This will overwrite your /etc/iptables/rules.v4 and /etc/iptables/rules.v6 files with the policies you crafted on the command line.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/etc/iptables.rules </div><div class="line">/etc/iptables/rules.v4</div><div class="line">/etc/iptables/rules.v6</div></pre></td></tr></table></figure><h1 id="Create-Your-Own-Firewall-by-iptables"><a href="#Create-Your-Own-Firewall-by-iptables" class="headerlink" title="Create Your Own Firewall by iptables"></a>Create Your Own Firewall by iptables</h1><p>Pre-condititions:</p><ul><li>Backup existing iptables. Could just copy output of <code>sudo iptables -S</code>, or copy rules saved by <code>iptables-persistent</code> as mentioned above.</li><li>If you lock yourself from accessing using ssh, make sure you have other ways to access it.</li></ul><h2 id="Create-Protocol-Specific-Chains"><a href="#Create-Protocol-Specific-Chains" class="headerlink" title="Create Protocol-Specific Chains"></a>Create Protocol-Specific Chains</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo iptables -N UDP</div><div class="line">sudo iptables -N TCP</div><div class="line">sudo iptables -N ICMP</div></pre></td></tr></table></figure><p>Enable ssh, http, https:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A TCP -p tcp --dport 22 -j ACCEPT</div><div class="line">sudo iptables -A TCP -p tcp --dport 80,443 -j ACCEPT</div></pre></td></tr></table></figure><p>Enable other custom service:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A TCP -p tcp --dport 8000:8010 -j ACCEPT</div><div class="line">sudo iptables -A UDP -p udp --dport 8000:8010 -j ACCEPT</div></pre></td></tr></table></figure><h2 id="Create-General-Purpose-Accept-and-Deny-Rules"><a href="#Create-General-Purpose-Accept-and-Deny-Rules" class="headerlink" title="Create General Purpose Accept and Deny Rules"></a>Create General Purpose Accept and Deny Rules</h2><p>First, we will create an exception to accept all traffic that is part of an established connection or is related to an established connection:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</div></pre></td></tr></table></figure><p>Allow all traffic originating on the local loopback interface.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -i lo -j ACCEPT</div></pre></td></tr></table></figure><p>Finally, we want to deny all invalid packets.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -m conntrack --ctstate INVALID -j DROP</div></pre></td></tr></table></figure><h2 id="Creating-the-Jump-Rules-to-the-Protocol-Specific-Chains"><a href="#Creating-the-Jump-Rules-to-the-Protocol-Specific-Chains" class="headerlink" title="Creating the Jump Rules to the Protocol-Specific Chains"></a>Creating the Jump Rules to the Protocol-Specific Chains</h2><p>Direct traffic in the INPUT chain into the appropriate protocol-specific chains.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -p udp -m conntrack --ctstate NEW -j UDP</div><div class="line">sudo iptables -A INPUT -p tcp --syn -m conntrack --ctstate NEW -j TCP</div><div class="line">sudo iptables -A INPUT -p icmp -m conntrack --ctstate NEW -j ICMP</div></pre></td></tr></table></figure><h2 id="Reject-All-Remaining-Traffic"><a href="#Reject-All-Remaining-Traffic" class="headerlink" title="Reject All Remaining Traffic"></a>Reject All Remaining Traffic</h2><p>If a packet that was passed to a protocol-specific chain did not match any of the rules within, control will be passed back to the INPUT chain. Anything that reaches this point should not be allowed by our firewall. We will deny the traffic using the REJECT target, which sends a response message to the client.</p><p>Attempting to reach a closed UDP port will result in an ICMP “port unreachable” message.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable</div></pre></td></tr></table></figure><p>Attempting to establish a TCP connection on a closed port results in a TCP RST response:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset</div></pre></td></tr></table></figure><p>For all other packets, we can send an ICMP “protocol unreachable” message to indicate that the server doesn’t respond to packets of that type:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -A INPUT -j REJECT --reject-with icmp-proto-unreachable</div></pre></td></tr></table></figure><h2 id="Adjusting-Default-Policies"><a href="#Adjusting-Default-Policies" class="headerlink" title="Adjusting Default Policies"></a>Adjusting Default Policies</h2><p>Set the default policy to DROP as a precaution.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo iptables -P INPUT DROP</div><div class="line">sudo iptables -P FORWARD DROP</div><div class="line">sudo iptables -P OUTPUT ACCEPT</div></pre></td></tr></table></figure><h2 id="Saving-iptables-Rules"><a href="#Saving-iptables-Rules" class="headerlink" title="Saving iptables Rules"></a>Saving iptables Rules</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo service netfilter-persistent save</div><div class="line">or </div><div class="line">sudo /etc/init.d/iptables-persistent save</div></pre></td></tr></table></figure><p>This will overwrite your /etc/iptables/rules.v4 and /etc/iptables/rules.v6 files with the policies you crafted on the command line.</p><h1 id="Test-your-Firewall-Configuration-with-Nmap-and-Tcpdump"><a href="#Test-your-Firewall-Configuration-with-Nmap-and-Tcpdump" class="headerlink" title="Test your Firewall Configuration with Nmap and Tcpdump"></a>Test your Firewall Configuration with Nmap and Tcpdump</h1><p><a href="https://www.digitalocean.com/community/tutorials/how-to-test-your-firewall-configuration-with-nmap-and-tcpdump" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-test-your-firewall-configuration-with-nmap-and-tcpdump</a></p><p>Preconditions:</p><ul><li>Install tcpdump build-essential libssl-dev, nmap</li></ul><h2 id="Scan-your-Target-for-Open-TCP-Ports"><a href="#Scan-your-Target-for-Open-TCP-Ports" class="headerlink" title="Scan your Target for Open TCP Ports"></a>Scan your Target for Open TCP Ports</h2><p>Setting Up the Packet Capture</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo tcpdump host target_ip_addr -w ~/scan_results/syn_scan/packets</div></pre></td></tr></table></figure><p>With <code>tcpdump</code> recording our traffic to the target machine, we are ready to run the SYN scan using <code>nmap</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nmap -sS -Pn -p- -T4 -vv --reason -oN ~/scan_results/syn_scan/nmap.results target_ip_addr</div></pre></td></tr></table></figure><p>The results are saved in ~/scan_results/syn_scan/nmap.results.</p><h2 id="Scan-your-Target-for-Open-UDP-Ports"><a href="#Scan-your-Target-for-Open-UDP-Ports" class="headerlink" title="Scan your Target for Open UDP Ports"></a>Scan your Target for Open UDP Ports</h2><p>Setting Up the Packet Capture</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo tcpdump host target_ip_addr -w ~/scan_results/udp_scan/packets</div></pre></td></tr></table></figure><p>Run the UDP Scan</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nmap -sU -Pn -p- -T4 -vv --reason -oN ~/scan_results/udp_scan/nmap.results target_ip_addr</div></pre></td></tr></table></figure><p>The results are saved in ~/scan_results/syn_scan/nmap.results.</p><h2 id="Host-and-Service-Discovery"><a href="#Host-and-Service-Discovery" class="headerlink" title="Host and Service Discovery"></a>Host and Service Discovery</h2><p>Discovering the Versions of Services on the Server</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nmap -sV -Pn -p 22,80 -vv --reason -oN ~/scan_results/versions/service_versions.nmap target_ip_addr</div></pre></td></tr></table></figure><p>Discovering the Host Operating System</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo nmap -O -Pn -vv --reason -oN ~/scan_results/versions/os_version.nmap target_ip_addr</div></pre></td></tr></table></figure><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul><li><a href="https://www.digitalocean.com/community/tutorials/how-the-iptables-firewall-works" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-the-iptables-firewall-works</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-using-iptables-on-ubuntu-14-04" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-using-iptables-on-ubuntu-14-04</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules</a></li></ul></div><div></div><div></div><div></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/Cocoa/IAPHelper.html" rel="next" title="In-App Purchase Helper"><i class="fa fa-chevron-left"></i> In-App Purchase Helper</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/Cocoa/MacGoogleAnalytics.html" rel="prev" title="Google Analytics for Mac">Google Analytics for Mac <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview">Overview</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://i.imgur.com/lS5NEuU.jpg" alt="Jason"><p class="site-author-name" itemprop="name">Jason</p><p class="site-description motion-element" itemprop="description">Digital Nomad, Mac Developer</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/"><span class="site-state-item-count">12</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">2</span> <span class="site-state-item-name">categories</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/atjason" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub </a></span><span class="links-of-author-item"><a href="https://twitter.com/hereisjason" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://toolinbox.net/" title="Toolinbox" target="_blank">Toolinbox</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#How-iptables-Works"><span class="nav-number">1.</span> <span class="nav-text">How iptables Works</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#rules"><span class="nav-number">1.1.</span> <span class="nav-text">rules</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#chains"><span class="nav-number">1.2.</span> <span class="nav-text">chains</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#policy"><span class="nav-number">1.2.1.</span> <span class="nav-text">policy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#target"><span class="nav-number">1.3.</span> <span class="nav-text">target</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPv4-Versus-IPv6"><span class="nav-number">1.4.</span> <span class="nav-text">IPv4 Versus IPv6</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Things-to-Keep-in-Mind"><span class="nav-number">1.5.</span> <span class="nav-text">Things to Keep in Mind</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#List-Rules"><span class="nav-number">2.</span> <span class="nav-text">List Rules</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#List-Specific-Chain"><span class="nav-number">2.1.</span> <span class="nav-text">List Specific Chain</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Add-Rules"><span class="nav-number">3.</span> <span class="nav-text">Add Rules</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Delete-Rules"><span class="nav-number">4.</span> <span class="nav-text">Delete Rules</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Delete-Rule-by-Specification"><span class="nav-number">4.1.</span> <span class="nav-text">Delete Rule by Specification</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Delete-Rule-by-Chain-and-Number"><span class="nav-number">4.2.</span> <span class="nav-text">Delete Rule by Chain and Number</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Drop-Rules"><span class="nav-number">5.</span> <span class="nav-text">Drop Rules</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Block-an-IP-Address"><span class="nav-number">6.</span> <span class="nav-text">Block an IP Address</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Show-Packet-Counts-and-Aggregate-Size"><span class="nav-number">7.</span> <span class="nav-text">Show Packet Counts and Aggregate Size</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reset-Packet-Counts-and-Aggregate-Size"><span class="nav-number">7.1.</span> <span class="nav-text">Reset Packet Counts and Aggregate Size</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Save-iptables-Configuration"><span class="nav-number">8.</span> <span class="nav-text">Save iptables Configuration</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create-Your-Own-Firewall-by-iptables"><span class="nav-number">9.</span> <span class="nav-text">Create Your Own Firewall by iptables</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Protocol-Specific-Chains"><span class="nav-number">9.1.</span> <span class="nav-text">Create Protocol-Specific Chains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-General-Purpose-Accept-and-Deny-Rules"><span class="nav-number">9.2.</span> <span class="nav-text">Create General Purpose Accept and Deny Rules</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-the-Jump-Rules-to-the-Protocol-Specific-Chains"><span class="nav-number">9.3.</span> <span class="nav-text">Creating the Jump Rules to the Protocol-Specific Chains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reject-All-Remaining-Traffic"><span class="nav-number">9.4.</span> <span class="nav-text">Reject All Remaining Traffic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Adjusting-Default-Policies"><span class="nav-number">9.5.</span> <span class="nav-text">Adjusting Default Policies</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Saving-iptables-Rules"><span class="nav-number">9.6.</span> <span class="nav-text">Saving iptables Rules</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Test-your-Firewall-Configuration-with-Nmap-and-Tcpdump"><span class="nav-number">10.</span> <span class="nav-text">Test your Firewall Configuration with Nmap and Tcpdump</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Scan-your-Target-for-Open-TCP-Ports"><span class="nav-number">10.1.</span> <span class="nav-text">Scan your Target for Open TCP Ports</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scan-your-Target-for-Open-UDP-Ports"><span class="nav-number">10.2.</span> <span class="nav-text">Scan your Target for Open UDP Ports</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Host-and-Service-Discovery"><span class="nav-number">10.3.</span> <span class="nav-text">Host and Service Discovery</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">11.</span> <span class="nav-text">References</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2011 - <span itemprop="copyrightYear">2017</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Jason</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><script type="text/javascript">var disqus_config=function(){this.page.url="https://en.atjason.com/IT/iptables.html",this.page.identifier="IT/iptables.html",this.page.title="iptables"},d=document,s=d.createElement("script");s.src="https://jason-en.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle(),$("#local-search-input").focus()}var isfetched=!1,search_path="search.xml";0===search_path.length&&(search_path="search.xml");var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),r=document.getElementById(t),s=document.getElementById(o);r.addEventListener("input",function(){var e=this.value.trim().toLowerCase().split(/[\s\-]+/),t=[];if(this.value.trim().length>0&&n.forEach(function(o){function n(e,t,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=e.substring(t,o),c=[],l=0;s+a.length<=o&&0!=n.length;){var h=s-t,p=s-t+a.length;for(c.push(i.substring(l,h)),c.push('<b class="search-keyword">'+i.substring(h,p)+"</b>"),n.pop(),l=p;0!=n.length&&(r=n[n.length-1],s=r.position,a=r.word,l>s-t);)n.pop()}return c.push(i.substring(l)),c.join("")}var r=!1,s=0,a=o.title.trim(),i=a.toLowerCase(),c=o.content.trim().replace(/<[^>]+>/g,""),l=c.toLowerCase(),h=decodeURIComponent(o.url),p=[],u=[];if(""!=a&&(e.forEach(function(e,t){function o(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}p=p.concat(o(e,i,!1)),u=u.concat(o(e,l,!1))}),(p.length>0||u.length>0)&&(r=!0,s=p.length+u.length)),r){var f="";p.sort(function(e,t){return t.position-e.position}),u.sort(function(e,t){return t.position-e.position}),0!=p.length?f+="<li><a href='"+h+"' class='search-result-title'>"+n(a,0,a.length,p)+"</a>":f+="<li><a href='"+h+"' class='search-result-title'>"+a+"</a>";var d=parseInt(1),g=!1;-1===d&&(g=!0);for(var v=0;0!=u.length&&(g||v<d);){var $=u[u.length-1],m=$.position,C=$.word,w=m-20,y=m+80;w<0&&(w=0),y<m+C.length&&(y=m+C.length),y>c.length&&(y=c.length),f+="<a href='"+h+'\'><p class="search-result">'+n(c,w,y,u)+"...</p></a>",v++}f+="</li>",t.push({item:f,hitCount:s,id:t.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===t.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{t.sort(function(e,t){return e.hitCount!=t.hitCount?t.hitCount-e.hitCount:e.id-t.id});var o='<ul class="search-result-list">';t.forEach(function(e,t){o+=e.item}),o+="</ul>",s.innerHTML=o}}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()})</script></body></html>